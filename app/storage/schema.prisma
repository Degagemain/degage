datasource db {
    provider = "postgresql"
}

generator client {
    provider = "prisma-client"
    output   = "client"

    importFileExtension = "ts"
}

model Car {
    id        String   @id @default(uuid())
    name      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model FuelType {
    id               String                @id @default(uuid())
    code             String                @unique
    isActive         Boolean               @default(true)
    pricePer         Decimal               @default(0)
    co2Contribution  Int                   @default(0)
    translations     FuelTypeTranslation[]
    carTypes         CarType[]
    simulations      Simulation[]
    createdAt        DateTime              @default(now())
    updatedAt        DateTime              @updatedAt
}

model FuelTypeTranslation {
    id         String   @id @default(uuid())
    fuelTypeId String
    fuelType   FuelType @relation(fields: [fuelTypeId], references: [id], onDelete: Cascade)
    locale     String
    name       String

    @@unique([fuelTypeId, locale])
}

model CarBrand {
    id           String                @id @default(uuid())
    code         String                @unique
    isActive     Boolean               @default(true)
    translations CarBrandTranslation[]
    carTypes     CarType[]
    simulations  Simulation[]
    createdAt    DateTime              @default(now())
    updatedAt    DateTime              @updatedAt
}

model CarBrandTranslation {
    id         String   @id @default(uuid())
    carBrandId String
    carBrand   CarBrand @relation(fields: [carBrandId], references: [id], onDelete: Cascade)
    locale     String
    name       String

    @@unique([carBrandId, locale])
}

model CarType {
    id                 String              @id @default(uuid())
    brandId            String
    brand              CarBrand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
    fuelTypeId         String
    fuelType           FuelType            @relation(fields: [fuelTypeId], references: [id])
    name               String
    ecoscore           Int
    isActive           Boolean             @default(true)
    simulations        Simulation[]
    carPriceEstimates  CarPriceEstimate[]
    carInfos           CarInfo[]
    createdAt          DateTime            @default(now())
    updatedAt          DateTime            @updatedAt
}

enum SimulationResultCode {
    notOk
    categoryA
    categoryB
    higherRate
    manualReview
}

model Simulation {
    id                String               @id @default(uuid())
    townId            String
    town              Town                 @relation(fields: [townId], references: [id])
    brandId           String
    brand             CarBrand             @relation(fields: [brandId], references: [id])
    fuelTypeId        String
    fuelType          FuelType             @relation(fields: [fuelTypeId], references: [id])
    carTypeId         String?
    carType           CarType?             @relation(fields: [carTypeId], references: [id])
    carTypeOther      String?
    km                Int
    ownerKmPerYear    Int
    seats             Int                  @default(0)
    firstRegisteredAt DateTime
    isVan             Boolean              @default(false)
    resultCode        SimulationResultCode
    estimatedPrice    Decimal?
    cylinderCc        Int?
    co2Emission       Int?
    ecoscore          Int?
    euroNormCode      String?
    consumption       Float?
    steps             Json                 @default("[]")
    createdAt         DateTime             @default(now())
    updatedAt         DateTime             @updatedAt
}

model EuroNorm {
    id                    String            @id @default(uuid())
    code                  String            @unique
    name                  String
    group                 Int               @default(0)
    isActive              Boolean           @default(true)
    start                 DateTime
    end                   DateTime?
    createdAt             DateTime          @default(now())
    updatedAt             DateTime          @updatedAt
    systemParameterValues SystemParameter[]
    carInfos              CarInfo[]
}

model FiscalRegion {
    id                        String                        @id @default(uuid())
    code                      String                        @unique
    isDefault                 Boolean                       @default(true)
    translations              FiscalRegionTranslation[]
    provinces                 Province[]
    carTaxBaseRates           CarTaxBaseRate[]
    carTaxEuroNormAdjustments CarTaxEuroNormAdjustment[]
    carTaxFlatRates           CarTaxFlatRate[]
    createdAt                 DateTime                      @default(now())
    updatedAt                 DateTime                      @updatedAt
}

model CarTaxEuroNormAdjustment {
    id                String       @id @default(uuid())
    fiscalRegionId    String
    fiscalRegion      FiscalRegion @relation(fields: [fiscalRegionId], references: [id], onDelete: Cascade)
    euroNormGroup     Int
    defaultAdjustment Decimal      @default(0)
    dieselAdjustment  Decimal      @default(0)
    createdAt         DateTime     @default(now())
    updatedAt         DateTime     @updatedAt
}

model CarTaxBaseRate {
    id              String       @id @default(uuid())
    fiscalRegionId  String
    fiscalRegion    FiscalRegion @relation(fields: [fiscalRegionId], references: [id], onDelete: Cascade)
    maxCc           Int
    fiscalPk        Int
    start           DateTime?
    end             DateTime?
    rate            Decimal
    createdAt       DateTime     @default(now())
    updatedAt       DateTime     @updatedAt
}

model CarTaxFlatRate {
    id              String       @id @default(uuid())
    fiscalRegionId  String
    fiscalRegion    FiscalRegion @relation(fields: [fiscalRegionId], references: [id], onDelete: Cascade)
    start           DateTime?
    rate            Decimal
    createdAt       DateTime     @default(now())
    updatedAt       DateTime     @updatedAt
}

model FiscalRegionTranslation {
    id              String       @id @default(uuid())
    fiscalRegionId  String
    fiscalRegion    FiscalRegion @relation(fields: [fiscalRegionId], references: [id], onDelete: Cascade)
    locale          String
    name            String

    @@unique([fiscalRegionId, locale])
}

model Province {
    id               String       @id @default(uuid())
    name             String
    fiscalRegionId   String
    fiscalRegion     FiscalRegion @relation(fields: [fiscalRegionId], references: [id])
    towns            Town[]
    createdAt        DateTime     @default(now())
    updatedAt        DateTime     @updatedAt
}

model Hub {
    id                        String   @id @default(uuid())
    name                      String
    isDefault                 Boolean  @default(false)
    simMaxAge                 Int      @default(15)
    simMaxKm                  Int      @default(200000)
    simMinEuroNormGroupDiesel Int      @default(5)
    simMinEcoScoreForBonus    Int      @default(65)
    simMaxKmForBonus          Int      @default(140000)
    simMaxAgeForBonus         Int      @default(7)
    simDepreciationKm         Int      @default(250000)
    simDepreciationKmElectric Int      @default(320000)
    simInspectionCostPerYear  Decimal  @default(43)
    simMaintenanceCostPerYear Decimal  @default(950)
    towns                     Town[]
    benchmarks                HubBenchmark[]
    createdAt                 DateTime @default(now())
    updatedAt                 DateTime @updatedAt
}

model HubBenchmark {
    id           String   @id @default(uuid())
    hubId        String
    hub          Hub      @relation(fields: [hubId], references: [id], onDelete: Cascade)
    ownerKm      Int
    sharedMinKm  Int      @default(0)
    sharedMaxKm  Int      @default(0)
    sharedAvgKm  Int      @default(0)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    @@unique([hubId, ownerKm])
}

model InsurancePriceBenchmark {
    id          String   @id @default(uuid())
    year        Int
    maxCarPrice Int
    baseRate    Decimal
    rate        Decimal
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@unique([year, maxCarPrice])
}

model CarPriceEstimate {
    id          String   @id @default(uuid())
    carTypeId   String
    carType     CarType  @relation(fields: [carTypeId], references: [id])
    year        Int
    price       Decimal
    rangeMin    Decimal
    rangeMax    Decimal
    prompt      String?
    remarks     String?
    articleRefs String[]
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
}

model CarInfo {
    id          String    @id @default(uuid())
    carTypeId   String
    carType     CarType   @relation(fields: [carTypeId], references: [id], onDelete: Cascade)
    year        Int
    cylinderCc  Int
    co2Emission Int
    ecoscore    Int
    euroNormId  String?
    euroNorm    EuroNorm? @relation(fields: [euroNormId], references: [id])
    consumption Float
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    @@unique([carTypeId, year])
}

model Town {
    id               String       @id @default(uuid())
    zip              String
    name             String
    municipality     String
    provinceId       String
    province         Province     @relation(fields: [provinceId], references: [id])
    highDemand       Boolean      @default(false) @map("highDemand")
    hasActiveMembers Boolean      @default(false)
    hubId            String
    hub              Hub          @relation(fields: [hubId], references: [id])
    simulations      Simulation[]
    createdAt        DateTime     @default(now())
    updatedAt        DateTime     @updatedAt
}

enum SystemParameterCategory {
    simulation
}

enum SystemParameterType {
    number
    number_range
    euronorm
}

model SystemParameter {
    id              String                       @id @default(uuid())
    code            String                       @unique
    category        SystemParameterCategory
    type            SystemParameterType
    valueNumber     Float?
    valueNumberMin  Float?
    valueNumberMax  Float?
    valueEuronormId String?
    valueEuronorm   EuroNorm?                    @relation(fields: [valueEuronormId], references: [id])
    translations    SystemParameterTranslation[]
    createdAt       DateTime                     @default(now())
    updatedAt       DateTime                     @updatedAt
}

model SystemParameterTranslation {
    id                String          @id @default(uuid())
    systemParameterId String
    systemParameter   SystemParameter @relation(fields: [systemParameterId], references: [id], onDelete: Cascade)
    locale            String
    name              String
    description       String          @default("")

    @@unique([systemParameterId, locale])
}

model User {
    id            String    @id
    name          String
    email         String
    emailVerified Boolean   @default(false)
    image         String?
    locale        String?   @default("en")
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @default(now()) @updatedAt
    role          String?
    banned        Boolean?  @default(false)
    banReason     String?
    banExpires    DateTime?
    sessions      Session[]
    accounts      Account[]

    @@unique([email])
    @@map("user")
}

model Session {
    id             String   @id
    expiresAt      DateTime
    token          String
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt
    ipAddress      String?
    userAgent      String?
    userId         String
    user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    impersonatedBy String?

    @@unique([token])
    @@map("session")
}

model Account {
    id                    String    @id
    accountId             String
    providerId            String
    userId                String
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt

    @@map("account")
}

model Verification {
    id         String   @id
    identifier String
    value      String
    expiresAt  DateTime
    createdAt  DateTime @default(now())
    updatedAt  DateTime @default(now()) @updatedAt

    @@map("verification")
}
